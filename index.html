<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Intercontinental Audio System Mk. II</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        :root {
            --bg-color: #12121e;
            --secondary-bg-color: #1e1e30;
            --text-color: #e0e0e0;
            --highlight-color: #00ffc8;
            --accent-color: #4b0082;
            --screen-bg: #0d0d20;
            --screen-text: #00ffc8;
            --shadow-dark: #0a0a14;
            --shadow-light: #22223a;
            --status-online-color: #00ff00;
            --status-offline-color: #FF4500;
        }
        .industrial-cyber { --bg-color: #0d0d0d; --secondary-bg-color: #1a1a1a; --text-color: #c0c0c0; --highlight-color: #ff0077; --accent-color: #00ffff; --screen-bg: #000; --screen-text: #ff0077; --shadow-dark: #000; --shadow-light: #333333; --status-online-color: #39ff14; }
        .cosmic-dark { --bg-color: #12121e; --secondary-bg-color: #1e1e30; --text-color: #e0e0e0; --highlight-color: #00ffc8; --accent-color: #4b0082; --screen-bg: #0d0d20; --screen-text: #00ffc8; --shadow-dark: #0a0a14; --shadow-light: #22223a; }
        .solar-flare { --bg-color: #2e0800; --secondary-bg-color: #4f1100; --text-color: #fff8e1; --highlight-color: #ffaa00; --accent-color: #ff4500; --screen-bg: #3b0a00; --screen-text: #ffaa00; --shadow-dark: #1f0500; --shadow-light: #6e1500; }
        .deep-ocean { --bg-color: #001f3f; --secondary-bg-color: #003366; --text-color: #e0f7fa; --highlight-color: #7fffd4; --accent-color: #4169e1; --screen-bg: #002b5c; --screen-text: #7fffd4; --shadow-dark: #00142b; --shadow-light: #004d99; }
        .neon-city { --bg-color: #0f0f0f; --secondary-bg-color: #2a0a2a; --text-color: #f0f0f0; --highlight-color: #ff1aff; --accent-color: #00ffff; --screen-bg: #1a051a; --screen-text: #ff1aff; --shadow-dark: #000000; --shadow-light: #440044; }
        .retro-crt { --bg-color: #050505; --secondary-bg-color: #101010; --text-color: #39ff14; --highlight-color: #39ff14; --accent-color: #00aa00; --screen-bg: #000000; --screen-text: #39ff14; --shadow-dark: #000; --shadow-light: #222; }
        .retro-wave { --bg-color: #200020; --secondary-bg-color: #380038; --text-color: #ffc8ff; --highlight-color: #ff77ff; --accent-color: #00c8ff; --screen-bg: #2b002b; --screen-text: #ff77ff; --shadow-dark: #150015; --shadow-light: #500050; }
        .vaporwave { --bg-color: #1e0f3f; --secondary-bg-color: #3a1e5f; --text-color: #fefefe; --highlight-color: #ff69b4; --accent-color: #00fefe; --screen-bg: #291549; --screen-text: #ff69b4; --shadow-dark: #0f0720; --shadow-light: #552f85; }
        .matrix-code { --bg-color: #051405; --secondary-bg-color: #1a3a1a; --text-color: #aaffaa; --highlight-color: #39ff14; --accent-color: #00aa00; --screen-bg: #000; --screen-text: #39ff14; --shadow-dark: #000000; --shadow-light: #2c592c; }
        .arctic-ice { --bg-color: #edf7f8; --secondary-bg-color: #d0e4e7; --text-color: #003366; --highlight-color: #64f4ff; --accent-color: #b3e5fc; --screen-bg: #c0dfe6; --screen-text: #003366; --shadow-dark: #c1d3d5; --shadow-light: #ffffff; }
        .gold-dust { --bg-color: #332b1b; --secondary-bg-color: #554422; --text-color: #fff8dc; --highlight-color: #ffd700; --accent-color: #aa8d00; --screen-bg: #443a2a; --screen-text: #ffd700; --shadow-dark: #1e1a10; --shadow-light: #776033; }
        .martian-sand { --bg-color: #4a2d24; --secondary-bg-color: #6a443b; --text-color: #f7f0e3; --highlight-color: #ff7f50; --accent-color: #a0522d; --screen-bg: #5c3730; --screen-text: #ff7f50; --shadow-dark: #3a221e; --shadow-light: #8a5a4a; }
        .emerald-forest { --bg-color: #0a2b1f; --secondary-bg-color: #1c4d3c; --text-color: #ccffcc; --highlight-color: #39ff14; --accent-color: #008000; --screen-bg: #14382c; --screen-text: #39ff14; --shadow-dark: #072219; --shadow-light: #2c6851; }
        .amethyst-dream { --bg-color: #2e0a4f; --secondary-bg-color: #4b1a7f; --text-color: #fff0f5; --highlight-color: #e6e6fa; --accent-color: #9932cc; --screen-bg: #3c1466; --screen-text: #e6e6fa; --shadow-dark: #1f0735; --shadow-light: #6a22b0; }
        .fire-ice { --bg-color: #1f1f1f; --secondary-bg-color: #3a3a3a; --text-color: #f0f0f0; --highlight-color: #ff4500; --accent-color: #00ffff; --screen-bg: #2a2a2a; --screen-text: #ff4500; --shadow-dark: #0a0a0a; --shadow-light: #5a5a5a; }
        .concrete-jungle { --bg-color: #505050; --secondary-bg-color: #6a6a6a; --text-color: #eeeeee; --highlight-color: #c0c0c0; --accent-color: #808080; --screen-bg: #404040; --screen-text: #c0c0c0; --shadow-dark: #3a3a3a; --shadow-light: #8a8a8a; }
        .sunset-strip { --bg-color: #3a1a3a; --secondary-bg-color: #552255; --text-color: #fff8e1; --highlight-color: #ff8c00; --accent-color: #ff1493; --screen-bg: #4a224a; --screen-text: #ff8c00; --shadow-dark: #2a102a; --shadow-light: #7a357a; }
        .biohazard-green { --bg-color: #1a1a00; --secondary-bg-color: #3a3a00; --text-color: #eeff88; --highlight-color: #ccff00; --accent-color: #8cff00; --screen-bg: #2a2a00; --screen-text: #ccff00; --shadow-dark: #0a0a00; --shadow-light: #5a5a00; }
        .pure-white { --bg-color: #f7f7f7; --secondary-bg-color: #e0e0e0; --text-color: #333333; --highlight-color: #007bff; --accent-color: #6c757d; --screen-bg: #ffffff; --screen-text: #007bff; --shadow-dark: #c0c0c0; --shadow-light: #ffffff; }
        .chroma-glow { --bg-color: #100010; --secondary-bg-color: #200020; --text-color: #ffffff; --highlight-color: #ff00ff; --accent-color: #00ffff; --screen-bg: #000; --screen-text: #ff00ff; --shadow-dark: #000; --shadow-light: #300030; }
        .dark-matter { --bg-color: #111111; --secondary-bg-color: #222222; --text-color: #666666; --highlight-color: #333333; --accent-color: #1c1c1c; --screen-bg: #0a0a0a; --screen-text: #333333; --shadow-dark: #000; --shadow-light: #333; }
        .volcano-ash { --bg-color: #2b1f1a; --secondary-bg-color: #4a3833; --text-color: #fcfcfc; --highlight-color: #ff4500; --accent-color: #8b4513; --screen-bg: #382722; --screen-text: #ff4500; --shadow-dark: #1a1411; --shadow-light: #6a504a; }
        .purple-haze { --bg-color: #2c0e4a; --secondary-bg-color: #4d1c83; --text-color: #e0e0e0; --highlight-color: #ff00ff; --accent-color: #8a2be2; --screen-bg: #3a1663; --screen-text: #ff00ff; --shadow-dark: #1d0930; --shadow-light: #6e27b8; }
        .cyber-red { --bg-color: #1a0000; --secondary-bg-color: #3a0000; --text-color: #ffaaaa; --highlight-color: #ff0000; --accent-color: #8b0000; --screen-bg: #2b0000; --screen-text: #ff0000; --shadow-dark: #000; --shadow-light: #5a0000; }
        .sky-blue { --bg-color: #0e2d4d; --secondary-bg-color: #1c4f87; --text-color: #f0f8ff; --highlight-color: #4682b4; --accent-color: #87ceeb; --screen-bg: #16426d; --screen-text: #4682b4; --shadow-dark: #091f33; --shadow-light: #2c68a1; }
        .lime-shock { --bg-color: #1c3d0e; --secondary-bg-color: #386b1c; --text-color: #e8ffe0; --highlight-color: #ccff00; --accent-color: #7cfc00; --screen-bg: #2a5216; --screen-text: #ccff00; --shadow-dark: #102607; --shadow-light: #4a8f27; }
        .carbon-fiber { --bg-color: #222222; --secondary-bg-color: #333333; --text-color: #999999; --highlight-color: #aaaaaa; --accent-color: #555555; --screen-bg: #111111; --screen-text: #aaaaaa; --shadow-dark: #0a0a0a; --shadow-light: #444444; }

        body { font-family: 'Orbitron', sans-serif; background-color: var(--bg-color); color: var(--text-color); transition: background-color 0.5s ease, color 0.5s ease; user-select: none; }
        .text-highlight { color: var(--highlight-color); }
        .text-screen { color: var(--screen-text); }
        .bg-main { background-color: var(--bg-color); }
        .bg-secondary { background-color: var(--secondary-bg-color); }
        .bg-screen { background-color: var(--screen-bg); }
        .border-accent { border-color: var(--accent-color); }
        .border-highlight { border-color: var(--highlight-color); }
        .shadow-out { box-shadow: 8px 8px 16px var(--shadow-dark), -8px -8px 16px var(--shadow-light); }
        .shadow-in { box-shadow: inset 5px 5px 10px var(--shadow-dark), inset -5px -5px 10px var(--shadow-light); }
        .text-glow { text-shadow: 0 0 10px var(--highlight-color); }
        .button-theme { background-color: var(--secondary-bg-color); color: var(--highlight-color); border: 1px solid var(--accent-color); transition: all 0.2s; }
        .button-theme:hover { background-color: var(--accent-color); color: var(--bg-color); }
        .button-theme.active { background-color: var(--highlight-color); color: var(--bg-color); border-color: var(--highlight-color); font-weight: bold; }
        .slider-thumb { background: var(--highlight-color); box-shadow: 0 0 5px var(--highlight-color); border: 1px solid var(--accent-color); }
        .slider-track { background: var(--shadow-dark); }
        
        /* Custom styles for range input to match theme */
        input[type=range] { -webkit-appearance: none; appearance: none; height: 8px; background: var(--shadow-dark); border-radius: 4px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 16px; height: 16px; border-radius: 50%; cursor: pointer; background: var(--highlight-color); box-shadow: 0 0 5px var(--highlight-color); border: 2px solid var(--accent-color); }
        input[type=range]::-moz-range-thumb { width: 16px; height: 16px; border-radius: 50%; cursor: pointer; background: var(--highlight-color); box-shadow: 0 0 5px var(--highlight-color); border: 2px solid var(--accent-color); }
        
        /* EQ Slider Orientation Fixes */
        .eq-slider-container {
            position: relative;
            height: 100px; /* Adjust height for vertical slider */
            width: 100%;
        }
        .eq-slider {
            -webkit-appearance: none;
            appearance: none;
            position: absolute;
            left: 50%;
            top: 50%;
            width: 100px; /* The length of the slider */
            height: 8px; /* The thickness of the slider track */
            transform: translate(-50%, -50%) rotate(-90deg);
            background: var(--shadow-dark);
            border-radius: 4px;
            cursor: pointer;
        }
        
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef, memo, useMemo } = React;

        // From constants.ts
        const EQ_FREQUENCIES = [60, 150, 400, 1000, 2500, 6000, 12000];
        const EQ_PRESETS = {
            'flat': [0, 0, 0, 0, 0, 0, 0],
            'rock': [5, 3, -4, -5, -2, 4, 6],
            'pop': [-2, 0, 2, 4, 2, 0, -2],
            'jazz': [4, 2, -2, -2, 0, 3, 4],
            'dance': [6, 4, 2, 0, -2, -3, 0],
            'metal': [6, 4, 0, -6, 0, 4, 7],
            'custom': null,
        };
        const THEMES = [
            'industrial-cyber', 'cosmic-dark', 'solar-flare', 'deep-ocean', 'neon-city', 'retro-crt', 
            'retro-wave', 'vaporwave', 'matrix-code', 'arctic-ice', 'gold-dust', 'martian-sand', 
            'emerald-forest', 'amethyst-dream', 'fire-ice', 'concrete-jungle', 'sunset-strip', 
            'biohazard-green', 'pure-white', 'chroma-glow', 'dark-matter', 'volcano-ash', 'purple-haze', 
            'cyber-red', 'sky-blue', 'lime-shock', 'carbon-fiber'
        ];
        // Nota: Substituído streams de exemplo por URLs válidas (ou mais plausíveis)
        const STREAMS = {
            'Synthwave Grid': 'https://synthwave.stream/stream',
            'Cosmic Noise (LoFi)': 'https://c20.radioboss.fm/stream/schizoid_minimal.mp3', 
            'Electro Swing': 'https://s2.radio.co/s23b8f2191/listen',
            'Intergalactic FM': 'https://c4.radioboss.fm/stream/185'
        };

        // Hooks and Components (Simplified for the final block)

        // From hooks/useAudioAnalyzer.ts (Modified to include EQ state and error handling)
        const useAudioAnalyzer = (streamUrl) => {
            const audioRef = useRef(null);
            const audioContextRef = useRef(null);
            const gainNodeRef = useRef(null);
            const eqFiltersRef = useRef([]);
            const mainAnalyserRef = useRef(null);
            const vuAnalyserLRef = useRef(null); // Simplified VU analysers for brevity
            const vuAnalyserRRef = useRef(null);
            const animationFrameRef = useRef(0);

            const [isInitialized, setIsInitialized] = useState(false);
            const [isPlaying, setIsPlaying] = useState(false);
            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState(null);
            const [eqGains, setEqGains] = useState(EQ_PRESETS.flat);
            const [eqPresetName, setEqPresetName] = useState('flat');
            
            const [audioData, setAudioData] = useState({
                frequencyData: new Uint8Array(1024),
                vu: { l: 0, r: 0 },
                volume: 50,
                isMuted: false,
                bassLevel: 0,
                dominantFrequency: 0,
            });

            // **************************************************************************************************************
            // FIX: Corrigido o erro de sintaxe 'last Node' para 'lastNode' e 'audioContext' para 'window.AudioContext'.
            // **************************************************************************************************************
            const initAudio = useCallback(() => {
                // Clear previous context/audio on re-init
                if (audioContextRef.current) {
                    audioContextRef.current.close();
                    audioContextRef.current = null;
                }
                if (audioRef.current) {
                    audioRef.current.pause();
                    audioRef.current = null;
                }

                setIsInitialized(false);
                setIsLoading(true);
                setError(null);

                try {
                    // Create Audio element
                    const audio = new Audio(streamUrl);
                    audio.crossOrigin = "anonymous";
                    audio.volume = 0; // Start muted to prevent noise on load until controls are set
                    audioRef.current = audio;

                    // Create Audio Context
                    const context = new (window.AudioContext || window.webkitAudioContext)();
                    audioContextRef.current = context;

                    // Create Nodes
                    const source = context.createMediaElementSource(audio);
                    const gainNode = context.createGain();
                    gainNode.gain.value = audioData.volume / 100;
                    gainNodeRef.current = gainNode;
                    
                    const filters = EQ_FREQUENCIES.map(freq => {
                        const filter = context.createBiquadFilter();
                        filter.type = 'peaking';
                        filter.frequency.value = freq;
                        filter.Q.value = 1.4;
                        filter.gain.value = 0;
                        return filter;
                    });
                    eqFiltersRef.current = filters;

                    const mainAnalyser = context.createAnalyser();
                    mainAnalyser.fftSize = 2048;
                    mainAnalyserRef.current = mainAnalyser;
                    
                    const splitter = context.createChannelSplitter(2);
                    vuAnalyserLRef.current = context.createAnalyser();
                    vuAnalyserRRef.current = context.createAnalyser();
                    vuAnalyserLRef.current.fftSize = 256;
                    vuAnalyserRRef.current.fftSize = 256;

                    // Connect the nodes
                    let lastNode = source;
                    filters.forEach(filter => {
                        lastNode.connect(filter);
                        lastNode = filter;
                    });

                    lastNode.connect(mainAnalyser);
                    mainAnalyser.connect(gainNode);
                    mainAnalyser.connect(splitter); // Splitter for stereo VU
                    gainNode.connect(context.destination);

                    splitter.connect(vuAnalyserLRef.current, 0);
                    splitter.connect(vuAnalyserRRef.current, 1);

                    audio.onloadeddata = () => setIsLoading(false);
                    audio.onplaying = () => { setIsPlaying(true); setIsLoading(false); };
                    audio.onpause = () => setIsPlaying(false);
                    audio.onstalled = () => setIsLoading(true);
                    audio.onerror = (e) => {
                        console.error("Audio Element Error:", e);
                        setError("Error loading audio stream. Check URL or network.");
                        setIsLoading(false);
                        setIsPlaying(false);
                    };

                    setIsInitialized(true);
                    // Apply EQ gains if they were already customized
                    eqFiltersRef.current.forEach((filter, index) => {
                         filter.gain.value = eqGains[index];
                    });
                    
                    // Set correct volume based on state
                    gainNodeRef.current.gain.value = audioData.isMuted ? 0 : audioData.volume / 100;

                } catch (e) {
                    console.error("Audio Initialization Error:", e);
                    setError("Audio initialization failed: " + e.message);
                    setIsLoading(false);
                }
            }, [streamUrl, audioData.volume, audioData.isMuted, eqGains]);
            // **************************************************************************************************************
            
            const analyzeData = useCallback(() => {
                if (!mainAnalyserRef.current || !isPlaying || audioContextRef.current?.state !== 'running') {
                    // Stop animation if not playing or context is suspended
                    cancelAnimationFrame(animationFrameRef.current);
                    animationFrameRef.current = 0;
                    return;
                }
                
                // Frequency Data (Visualizer)
                const frequencyData = new Uint8Array(mainAnalyserRef.current.frequencyBinCount);
                mainAnalyserRef.current.getByteFrequencyData(frequencyData);
                
                // VU Data (Level Meters)
                const bufferL = new Uint8Array(vuAnalyserLRef.current.fftSize);
                vuAnalyserLRef.current.getByteTimeDomainData(bufferL);
                const bufferR = new Uint8Array(vuAnalyserRRef.current.fftSize);
                vuAnalyserRRef.current.getByteTimeDomainData(bufferR);

                const getPeakLevel = (data) => {
                    let max = 0;
                    for (let i = 0; i < data.length; i++) {
                        const val = Math.abs(data[i] - 128);
                        if (val > max) max = val;
                    }
                    return (max / 128) * 100;
                };
                
                // Bass Level for Screen
                const bassBins = Math.floor((250 / (audioContextRef.current.sampleRate / 2)) * frequencyData.length);
                const bassSum = frequencyData.slice(0, bassBins).reduce((a, b) => a + b, 0);
                const bassLevel = (bassSum / (bassBins * 255)) * 100;

                // Dominant Frequency for Screen
                let maxVal = -1, maxIndex = 0;
                for(let i=0; i < frequencyData.length; i++){
                    if(frequencyData[i] > maxVal){
                        maxVal = frequencyData[i];
                        maxIndex = i;
                    }
                }
                const dominantFrequency = (maxIndex * audioContextRef.current.sampleRate) / mainAnalyserRef.current.fftSize;

                setAudioData(prev => ({
                    ...prev,
                    frequencyData,
                    vu: { l: getPeakLevel(bufferL), r: getPeakLevel(bufferR) },
                    bassLevel,
                    dominantFrequency: dominantFrequency > 20000 ? 0 : dominantFrequency,
                }));

                animationFrameRef.current = requestAnimationFrame(analyzeData);
            }, [isPlaying]);

            useEffect(() => {
                if (isPlaying) {
                    if (!animationFrameRef.current) { // Start frame only if not running
                        animationFrameRef.current = requestAnimationFrame(analyzeData);
                    }
                } else {
                    cancelAnimationFrame(animationFrameRef.current);
                    animationFrameRef.current = 0;
                }
                return () => cancelAnimationFrame(animationFrameRef.current);
            }, [isPlaying, analyzeData]);

            const play = useCallback(() => {
                if (!isInitialized) {
                    initAudio();
                }

                if (audioContextRef.current?.state === 'suspended') {
                    audioContextRef.current.resume();
                }
                
                if (audioRef.current) {
                    setIsLoading(true);
                    setError(null);
                    audioRef.current.play().then(() => {
                        // Play state set in audio.onplaying
                    }).catch(e => {
                        console.error("Playback Error:", e);
                        setError("Playback failed. Please interact with the page first (browser security).");
                        setIsLoading(false);
                        setIsPlaying(false);
                    });
                }
            }, [initAudio, isInitialized]);

            const pause = useCallback(() => {
                audioRef.current?.pause();
            }, []);

            const stop = useCallback(() => {
                if (audioRef.current) {
                    audioRef.current.pause();
                    audioRef.current.currentTime = 0;
                }
                setIsPlaying(false);
                setIsLoading(false);
            }, []);
            
            const setVolume = useCallback((vol) => {
                const newVolume = Math.max(0, Math.min(100, vol));
                setAudioData(prev => ({ ...prev, volume: newVolume }));
                if (gainNodeRef.current && !audioData.isMuted) {
                    gainNodeRef.current.gain.value = newVolume / 100;
                }
            }, [audioData.isMuted]);

            const toggleMute = useCallback(() => {
                const newMutedState = !audioData.isMuted;
                setAudioData(prev => ({ ...prev, isMuted: newMutedState }));
                if (gainNodeRef.current) {
                    gainNodeRef.current.gain.value = newMutedState ? 0 : audioData.volume / 100;
                }
            }, [audioData.isMuted, audioData.volume]);

            const setEQ = useCallback((gains, presetName = 'custom') => {
                eqFiltersRef.current.forEach((filter, index) => {
                    if (gains[index] !== undefined) filter.gain.value = gains[index];
                });
                setEqGains(gains);
                setEqPresetName(presetName);
            }, []);

            const setEQBand = useCallback((bandIndex, gain) => {
                if (eqFiltersRef.current[bandIndex]) {
                    eqFiltersRef.current[bandIndex].gain.value = gain;
                    setEqGains(prev => {
                        const newGains = [...prev];
                        newGains[bandIndex] = gain;
                        return newGains;
                    });
                    setEqPresetName('custom');
                }
            }, []);

            useEffect(() => {
                if (streamUrl && isInitialized) {
                    // Re-initialize audio on streamUrl change
                    stop(); // Pause and reset current stream
                    // Re-initialize audio context and nodes with the new stream URL
                    initAudio(); 
                } else if(streamUrl && !isInitialized) {
                    // Initial load/first stream selection
                    initAudio();
                }
            }, [streamUrl]);


            return { isInitialized, isPlaying, isLoading, error, audioData, eqGains, eqPresetName, controls: { play, pause, stop, setVolume, toggleMute, setEQ, setEQBand } };
        };

        // --- Components ---

        // InfoScreen
        const InfoScreen = memo(({ isPlaying, themeName, eqPresetName, volume, currentStream, dominantFrequency }) => {
            const [dateTime, setDateTime] = useState(new Date());
            useEffect(() => {
                const timer = setInterval(() => setDateTime(new Date()), 1000);
                return () => clearInterval(timer);
            }, []);
            const formattedTime = dateTime.toLocaleTimeString('en-US', { hour12: false });
            const formattedDate = dateTime.toLocaleDateString('en-CA');

            const statusColor = isPlaying ? 'var(--status-online-color)' : 'var(--status-offline-color)';
            const statusShadow = isPlaying ? '0 0 5px var(--status-online-color)' : '0 0 5px var(--status-offline-color)';
            
            return (
                <div className="bg-screen text-screen font-mono p-4 rounded-xl shadow-in border border-highlight/50 grid grid-cols-2 md:grid-cols-4 gap-3 text-sm md:text-base">
                    <div className="col-span-2 md:col-span-4 text-center border-b border-screen-text/30 pb-2 mb-2">
                        <p className="text-xl font-bold uppercase tracking-widest text-glow">{themeName.replace('-', ' ')}</p>
                        <p className="text-xs opacity-70 mt-1 truncate">SOURCE: {currentStream}</p>
                    </div>
                    
                    <div className="flex flex-col items-center justify-center p-2 border border-screen-text/30 rounded">
                        <p className="opacity-75">VOLUME</p>
                        <p className="text-lg font-bold">{volume}%</p>
                    </div>
                    <div className="flex flex-col items-center justify-center p-2 border border-screen-text/30 rounded">
                        <p className="opacity-75">EQ PRESET</p>
                        <p className="text-lg font-bold uppercase truncate">{eqPresetName}</p>
                    </div>
                    <div className="flex flex-col items-center justify-center p-2 border border-screen-text/30 rounded">
                        <p className="opacity-75">DOM. FREQ.</p>
                        <p className="text-lg font-bold">{dominantFrequency.toFixed(2)} Hz</p>
                    </div>
                    <div className="flex flex-col items-center justify-center p-2 border border-screen-text/30 rounded">
                        <p className="opacity-75">STATUS</p>
                        <div className="flex items-center gap-2">
                            <span className={`w-3 h-3 rounded-full transition-colors`} style={{ backgroundColor: statusColor, boxShadow: statusShadow }}></span>
                            <p className="text-lg font-bold text-glow">{isPlaying ? "ONLINE" : "OFFLINE"}</p>
                        </div>
                    </div>

                    <div className="col-span-2 md:col-span-4 text-center border-t border-screen-text/30 pt-2 mt-2 flex justify-between font-share-tech-mono">
                        <span>DATE: {formattedDate}</span>
                        <span>TIME: {formattedTime} UTC</span>
                    </div>
                </div>
            );
        });

        // VUBar and VUMeter (Slightly simplified and cleaned)
        const VUBar = memo(({ level, channel }) => {
            const safeLevel = Math.min(100, Math.max(0, level));
            return (
                <div className="w-5 h-28 bg-black/50 rounded-sm shadow-in overflow-hidden relative">
                    <div className="absolute bottom-0 left-0 w-full bg-gradient-to-t from-green-500 via-yellow-500 to-red-500 transition-[height] duration-75" style={{ height: `${safeLevel}%` }}></div>
                </div>
            );
        });

        const VUMeter = memo(({ vuData }) => {
            return (
                <div className="mt-4">
                    <p className="text-center font-mono text-sm mb-2 opacity-80">STEREO OUTPUT LEVEL</p>
                    <div className="flex justify-center items-end gap-3">
                        <div className="text-center">
                            <VUBar level={vuData.l} channel="L" />
                            <span className="font-mono text-xs opacity-70 mt-1 block">L</span>
                        </div>
                        <div className="text-center">
                            <VUBar level={vuData.r} channel="R" />
                            <span className="font-mono text-xs opacity-70 mt-1 block">R</span>
                        </div>
                    </div>
                </div>
            );
        });
        
        // Visualizer (Bar graph, slightly modified color logic)
        const Visualizer = memo(({ frequencyData, isPlaying }) => {
            const canvasRef = useRef(null);
            
            useEffect(() => {
                const canvas = canvasRef.current;
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                if (!ctx) return;
                const { width, height } = canvas;
                ctx.clearRect(0, 0, width, height);
                
                if (!isPlaying) {
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.05)';
                    ctx.font = '24px Orbitron';
                    ctx.textAlign = 'center';
                    ctx.fillText('SIGNAL OFFLINE', width / 2, height / 2);
                    return;
                }

                const numBars = 64; // Fewer bars for a cleaner look
                const barWidth = width / numBars;
                const highlightColor = getComputedStyle(document.documentElement).getPropertyValue('--highlight-color').trim();
                
                for (let i = 0; i < numBars; i++) {
                    const dataIndex = Math.floor(i * (frequencyData.length / numBars));
                    const value = frequencyData[dataIndex];
                    const barHeight = (value / 255) * height * 0.9; // Scale down a bit
                    
                    // Simple highlight color based visualization
                    const alpha = value / 255 * 0.8 + 0.2;
                    // FIX: Ensure hex conversion is safe (removes '#' if present)
                    const colorHex = highlightColor.startsWith('#') ? highlightColor.slice(1) : highlightColor;
                    const r = parseInt(colorHex.slice(0, 2), 16);
                    const g = parseInt(colorHex.slice(2, 4), 16);
                    const b = parseInt(colorHex.slice(4, 6), 16);
                    
                    ctx.fillStyle = `rgba(${r}, ${g}, ${b}, ${alpha})`;
                    
                    ctx.fillRect(i * barWidth, height - barHeight, barWidth - 1, barHeight);
                }
            }, [frequencyData, isPlaying]);
            
            return (
                <div className="w-full aspect-[3/1] bg-black rounded-lg shadow-in relative border border-highlight/30">
                    <canvas ref={canvasRef} width="600" height="200" className="w-full h-full" />
                </div>
            );
        });

        // EQSlider
        const EQSlider = memo(({ index, freq, gain, onGainChange }) => {
            return (
                <div className="flex flex-col items-center w-full eq-slider-container">
                    {/* The actual slider component - uses a fixed class for orientation */}
                    <input
                        type="range"
                        min="-12"
                        max="12"
                        step="0.1"
                        value={gain}
                        onChange={(e) => onGainChange(index, parseFloat(e.target.value))}
                        className="eq-slider"
                    />
                    <p className="text-xs font-mono absolute top-2 right-0 left-0 text-center text-highlight">{gain.toFixed(1)} dB</p>
                    <p className="text-xs font-mono absolute bottom-2 right-0 left-0 text-center opacity-70">{freq >= 1000 ? `${freq / 1000}k` : freq} Hz</p>
                </div>
            );
        });

        // Equalizer
        const Equalizer = ({ eqGains, controls, eqPresetName }) => {
            const handlePresetChange = (presetName) => {
                const gains = EQ_PRESETS[presetName];
                if (gains) {
                    controls.setEQ(gains, presetName);
                }
            };
            
            return (
                <div className="bg-secondary p-4 rounded-xl shadow-out border border-accent/50">
                    <h3 className="text-center text-lg font-bold text-highlight mb-4">EQUALIZER MODULE</h3>
                    
                    {/* EQ Sliders */}
                    <div className="flex justify-between items-start my-4 px-4 h-40">
                        {EQ_FREQUENCIES.map((freq, index) => (
                            <div key={index} className="flex flex-col items-center justify-center h-full w-1/7 relative">
                                <EQSlider 
                                    index={index} 
                                    freq={freq} 
                                    gain={eqGains[index]} 
                                    onGainChange={controls.setEQBand}
                                />
                            </div>
                        ))}
                    </div>

                    {/* Presets */}
                    <div className="flex flex-wrap justify-center gap-2 mt-4 border-t border-accent/50 pt-3">
                        {Object.keys(EQ_PRESETS).filter(k => k !== 'custom').map(preset => (
                            <button
                                key={preset}
                                onClick={() => handlePresetChange(preset)}
                                className={`button-theme px-3 py-1 text-xs rounded-full ${eqPresetName === preset ? 'active' : ''}`}
                            >
                                {preset.toUpperCase()}
                            </button>
                        ))}
                        {/* Show CUSTOM button if eqPresetName is 'custom' */}
                        {eqPresetName === 'custom' && (
                             <button
                                className={`button-theme px-3 py-1 text-xs rounded-full active`}
                                disabled
                            >
                                CUSTOM
                            </button>
                        )}
                    </div>
                </div>
            );
        };

        // ThemeSelector
        const ThemeSelector = ({ currentTheme, onThemeChange }) => (
            <div className="bg-secondary p-4 rounded-xl shadow-out border border-accent/50">
                <h3 className="text-center text-lg font-bold text-highlight mb-4">THEME CONFIG</h3>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-2 max-h-48 overflow-y-auto pr-2">
                    {THEMES.map(theme => (
                        <button
                            key={theme}
                            onClick={() => onThemeChange(theme)}
                            className={`button-theme px-3 py-1 text-xs rounded-full truncate ${currentTheme === theme ? 'active' : ''}`}
                        >
                            {theme.toUpperCase().replace('-', ' ')}
                        </button>
                    ))}
                </div>
            </div>
        );

        // StreamSelector
        const StreamSelector = ({ currentStreamName, onStreamChange, isPlaying, isLoading }) => (
            <div className="bg-secondary p-4 rounded-xl shadow-out border border-accent/50">
                <h3 className="text-center text-lg font-bold text-highlight mb-4">STREAM SELECT</h3>
                <div className="flex flex-col gap-2">
                    {Object.keys(STREAMS).map(name => (
                        <button
                            key={name}
                            onClick={() => onStreamChange(name)}
                            disabled={isLoading}
                            className={`button-theme text-sm p-2 rounded ${currentStreamName === name ? 'active' : ''}`}
                        >
                            {isLoading && currentStreamName === name ? (
                                <>
                                    <i className="fas fa-sync-alt animate-spin mr-2"></i> LOADING...
                                </>
                            ) : (
                                <>
                                    <i className={`mr-2 fas ${currentStreamName === name && isPlaying ? 'fa-volume-up' : 'fa-satellite-dish'}`}></i> {name}
                                </>
                            )}
                        </button>
                    ))}
                </div>
            </div>
        );

        // PlaybackControls
        const PlaybackControls = ({ isPlaying, isLoading, volume, isMuted, controls }) => {
            const currentIcon = isMuted ? 'fa-volume-mute' : (volume === 0 ? 'fa-volume-off' : (volume < 50 ? 'fa-volume-down' : 'fa-volume-up'));

            return (
                <div className="bg-secondary p-4 rounded-xl shadow-out border border-accent/50 flex flex-col items-center">
                    <h3 className="text-center text-lg font-bold text-highlight mb-4">TRANSPORT & VOLUME</h3>
                    
                    {/* Play/Pause/Stop Buttons */}
                    <div className="flex gap-4 mb-6">
                        <button
                            onClick={isPlaying ? controls.pause : controls.play}
                            disabled={isLoading}
                            className={`button-theme w-20 h-20 rounded-full text-3xl transition-transform ${isPlaying ? 'active' : ''}`}
                        >
                            <i className={`fas ${isPlaying ? 'fa-pause' : 'fa-play'} ${isLoading ? 'animate-pulse' : ''}`}></i>
                        </button>
                        <button
                            onClick={controls.stop}
                            className="button-theme w-20 h-20 rounded-full text-3xl"
                        >
                            <i className="fas fa-stop"></i>
                        </button>
                    </div>

                    {/* Volume Slider */}
                    <div className="w-full max-w-sm flex items-center gap-4">
                        <button onClick={controls.toggleMute} className="text-2xl text-highlight hover:text-accent transition-colors">
                            <i className={`fas ${currentIcon}`}></i>
                        </button>
                        <input
                            type="range"
                            min="0"
                            max="100"
                            step="1"
                            value={volume}
                            onChange={(e) => controls.setVolume(parseFloat(e.target.value))}
                            className="w-full"
                        />
                        <span className="font-mono text-lg text-highlight w-10 text-right">{volume}%</span>
                    </div>
                </div>
            );
        };


        // --- Main Application Component ---

        const App = () => {
            const [currentTheme, setCurrentTheme] = useState('cosmic-dark');
            const [currentStreamName, setCurrentStreamName] = useState('Synthwave Grid');
            const currentStreamUrl = STREAMS[currentStreamName];

            // Hook for audio analysis and control
            const { isInitialized, isPlaying, isLoading, error, audioData, eqGains, eqPresetName, controls } = useAudioAnalyzer(currentStreamUrl);

            // Apply theme class to body
            useEffect(() => {
                document.body.className = `p-4 md:p-8 min-h-screen ${currentTheme}`;
            }, [currentTheme]);

            const handleStreamChange = useCallback((name) => {
                setCurrentStreamName(name);
                // The useEffect in useAudioAnalyzer handles re-initialization
            }, []);

            return (
                <div className="max-w-7xl mx-auto space-y-8">
                    <header className="text-center mb-6">
                        <h1 className="text-4xl md:text-6xl font-bold text-highlight text-glow uppercase tracking-widest">
                            Intercontinental Audio System Mk. II
                        </h1>
                        <p className="font-mono text-sm opacity-70 mt-2">CYBERNETIC BROADCAST RECEIVER</p>
                    </header>

                    {/* Error Message Display */}
                    {error && (
                        <div className="bg-red-900 border border-red-500 text-red-300 p-4 rounded-xl shadow-out font-mono">
                            <i className="fas fa-exclamation-triangle mr-2"></i> **SYSTEM ERROR:** {error}
                        </div>
                    )}

                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        {/* Coluna Principal: Tela de Info e Visualizador */}
                        <div className="lg:col-span-2 space-y-6">
                            <InfoScreen 
                                isPlaying={isPlaying}
                                themeName={currentTheme}
                                eqPresetName={eqPresetName}
                                volume={audioData.volume}
                                currentStream={currentStreamName}
                                dominantFrequency={audioData.dominantFrequency}
                            />
                            
                            <Visualizer frequencyData={audioData.frequencyData} isPlaying={isPlaying} />
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <PlaybackControls 
                                    isPlaying={isPlaying} 
                                    isLoading={isLoading} 
                                    volume={audioData.volume} 
                                    isMuted={audioData.isMuted} 
                                    controls={controls}
                                />
                                <VUMeter vuData={audioData.vu} />
                            </div>
                        </div>

                        {/* Coluna Lateral: EQ, Stream e Theme */}
                        <div className="lg:col-span-1 space-y-8">
                            <Equalizer 
                                eqGains={eqGains} 
                                controls={controls} 
                                eqPresetName={eqPresetName}
                            />
                            
                            <StreamSelector 
                                currentStreamName={currentStreamName} 
                                onStreamChange={handleStreamChange} 
                                isPlaying={isPlaying}
                                isLoading={isLoading}
                            />
                            
                            <ThemeSelector 
                                currentTheme={currentTheme} 
                                onThemeChange={setCurrentTheme} 
                            />
                        </div>
                    </div>
                </div>
            );
        };

        // Render the application
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
